import subprocess
import os

def _plink_merge_ped_files(ped_file_main: str, ped_file_to_merge: str, plink_path: str ="./plink") -> str:
    """
    Merges two PED files using PLINK.

    Args:
        ped_file_main (str): The path to the main PED file (without extension).
        ped_file_to_merge (str): The path to the file to merge (without extension).
        plink_path (str): The path to the PLINK executable (default: "./plink").

    Returns:
        str: The path to the merged PED file (without extension).
    """

    output_ped_file = "merged_parentage" + ped_file_main
    merge_command = [
        plink_path,
        "--file", ped_file_main,
        "--merge", ped_file_to_merge,
        "--out", output_ped_file
    ]

    try:
        # Execute the PLINK command
        result = subprocess.run(merge_command, check=True, text=True, capture_output=True)
        print("PLINK output:")
        print(result.stdout)
    except subprocess.CalledProcessError as e:
        print("Error running PLINK:")
        print(e.stderr)
        raise
    except Exception as e:
        print(f"An unexpected error occurred: {e}")
        raise
    return output_ped_file

def _plink_convert_tped_to_ped(tped_file: str, plink_path: str="./plink") -> None:
    """
    Converts a TPED file to PED format using PLINK.

    Args:
        tped_file (str): The path to the TPED file (without extension).
        plink_path (str): The path to the PLINK executable.
        output_file (str): The desired output PED file path (without extension).
    """

    convert_command = [
        plink_path,
        "--tfile", tped_file,
        "--recode",
        "--out", tped_file
    ]

    try:
        # Execute the PLINK command
        result = subprocess.run(convert_command, check=True, text=True, capture_output=True)
        print("PLINK output:")
        print(result.stdout)
    except subprocess.CalledProcessError as e:
        print("Error running PLINK:")
        print(e.stderr)
        raise
    except Exception as e:
        print(f"An unexpected error occurred: {e}")
        raise

def plink_roh(input_file: str, output_folder: str, plink_path: str ="./plink",
        window_snp: int = 50, window_het: int = 1, window_missing: int = 5, window_threshold: float = 0.05,
        homozyg_gap: int = 1000, homozyg_het: int = 1000, homozyg_density: int = 50, homozyg_snp: int = 100, homozyg_kb: int = 1000
    ) -> None:

    """
    Sends a file to PLINK for Run of Homozygosity (RoH) analysis.

    Args:
        Filesystem:
            input_file (str):               Path to the input file for PLINK, without extension
            output_prefix (str):            Prefix for the output files generated by PLINK
            plink_path (str):               Path to the PLINK executable (default: "plink")
        PLINK Parameters (with default values):
            Defining the scanning window:
                window_snp (int):           Size of the scanning window in SNPs (default: 50)
                window_het (int):           Maximum number of heterozygous calls allowed in the scanning window (default: 1)
                window_missing (int):       Maximum number of missing calls allowed in the scanning window (default: 5)
                window_threshold (float):   Minimum scanning window hit rate (default: 0.05)
            Tresholds for calling a homozygous segment:
                homozyg_gap (int):          Maximum interval between two SNPs in a segment in kilobases (default: 1000)
                homozyg_het (int):          Maximum number of heterozygous calls in a homozygous segment (default: 1000) - This flag is disabled by default in PLINK
                homozyg_density (int):      Maximum inverse density of a homozygous segment (default: 50)
                homozyg_snp (int):          Minimum number of SNPs in a homozygous segment (default: 100)
                homozyg_kb (int):           Minimum length of a homozygous segment in kilobases (default: 1000)

    Outputs:
        Generates output files in the specified output folder:
            .hh         	                List of het. haploid and nonmale Ychr genotypes.
            .hom	                        Run-of-homozygosity list.
            .hom.indiv		                Sample-based runs-of-homozygosity report.
            .hom.summary    	            SNP-based runs-of-homozygosity report.
    """

    if not os.path.exists(input_file + ".tped"):
        raise FileNotFoundError(f"Input file '{input_file}' does not exist.")

    # Construct the PLINK command
    roh_command = [
        plink_path,
        "--tfile", input_file,
        "--dog",
        "--homozyg",
        "--homozyg-window-snp", str(window_snp),
        "--homozyg-window-het", str(window_het),
        "--homozyg-window-missing", str(window_missing),
        "--homozyg-window-threshold", str(window_threshold),
        "--homozyg-gap", str(homozyg_gap),
        "--homozyg-het", str(homozyg_het),
        "--homozyg-density", str(homozyg_density),
        "--homozyg-snp", str(homozyg_snp),
        "--homozyg-kb", str(homozyg_kb),
        "--out", output_folder
    ]

    try:
        # Execute the PLINK command
        result = subprocess.run(roh_command, check=True, text=True, capture_output=True)
        print("PLINK output:")
        print(result.stdout)
    except subprocess.CalledProcessError as e:
        print("Error running PLINK:")
        print(e.stderr)
        raise
    except Exception as e:
        print(f"An unexpected error occurred: {e}")
        raise

def plink_parentage(offspring_file: str, parent1_file: str, parent2_file: str, plink_path: str ="./plink") -> None:
    """
    Sends the target individual and potential parents' files to PLINK for parentage analysis.

    Args:
        offspring_file (str): The path to the file containing the offspring's genotypes.
        parent1_file (str): The path to the file containing the first parent's genotypes.
        parent2_file (str): The path to the file containing the second parent's genotypes.
        plink_path (str): The path to the PLINK executable (default: "./plink").
    """

    if not os.path.exists(offspring_file + ".tped"):
        raise FileNotFoundError(f"Offspring file '{offspring_file}' does not exist.")
    if not os.path.exists(parent1_file + ".tped"):
        raise FileNotFoundError(f"Parent 1 file '{parent1_file}' does not exist.")
    if not os.path.exists(parent2_file + ".tped"):
        raise FileNotFoundError(f"Parent 2 file '{parent2_file}' does not exist.")

    # Converts tped files to ped files
    _plink_convert_tped_to_ped(
        tped_file=offspring_file,
        plink_path=plink_path
    )
    _plink_convert_tped_to_ped(
        tped_file=parent1_file,
        plink_path=plink_path
    )
    _plink_convert_tped_to_ped(
        tped_file=parent2_file,
        plink_path=plink_path
    )

    # Merges parents' ped files with offspring ped file
    merged_ped_file = _plink_merge_ped_files(
        ped_file_main=offspring_file,
        ped_file_to_merge=parent1_file,
        plink_path=plink_path
    )
    _plink_merge_ped_files(
        ped_file_main=merged_ped_file,
        ped_file_to_merge=parent2_file,
        plink_path=plink_path
    )

    # Construct the PLINK command
    roh_command = [
        plink_path,
        "--file", merged_ped_file,
        "--dog",
        "--homozyg",
        "--out", output_folder
    ]

    try:
        # Execute the PLINK command
        result = subprocess.run(roh_command, check=True, text=True, capture_output=True)
        print("PLINK output:")
        print(result.stdout)
    except subprocess.CalledProcessError as e:
        print("Error running PLINK:")
        print(e.stderr)
        raise
    except Exception as e:
        print(f"An unexpected error occurred: {e}")
        raise

if __name__ == "__main__":
    # Example usage
    input_file = "/path/to/input_file"  # Replace with your input file path
    output_folder = "/path/to/output_prefix"  # Replace with your desired output prefix
    plink_path = "plink"  # Adjust if PLINK is not in your PATH

    try:
        plink_roh(input_file, output_folder, plink_path)
    except Exception as e:
        print(f"Failed to send file to PLINK: {e}")